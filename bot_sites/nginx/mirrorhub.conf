# /etc/nginx/sites-available/mirrorhub.conf
#
# Полностью автономный конфиг для MirrorHub.
# НИЧЕГО из основного проекта не трогаем.
# Здесь:
#  - собственный log_format (уникальное имя, чтобы не конфликтовать)
#  - map'ы для фильтра (https + наши домены + не боты)
#  - подключение per-domain конфигов из /etc/nginx/sites-mirrorhub.d/*.conf

# 1) формат JSON-лога (уникальное имя)
log_format json_mirrorhub_v1 escape=json
  '{'
    '"time":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"host":"$host",'
    '"domain":"$host",'
    '"request":"$request",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"referer":"$http_referer",'
    '"user_agent":"$http_user_agent",'
    '"method":"$request_method",'
    '"path":"$uri",'
    '"args":"$args"'
  '}';

# 2) флаг HTTPS
map $scheme $mh_is_https {
    default 0;
    https   1;
}

# 3) наши домены: подключаем внешний файл, генерируемый ботом
#    формат строк в файле:   example.com 1;
map $host $mh_is_mirrorhub {
    default 0;
    include /etc/nginx/mirrorhub/domains_map.conf;
}

# 4) известные боты по User-Agent
map $http_user_agent $mh_is_known_bot {
    default 0;
    ~*googlebot|adsbot-google|google-inspectiontool|apis-google      1;
    ~*yandex(bot|images|metrika|mobile)                              1;
    ~*bingbot|duckduckbot|baiduspider|applebot                       1;
    ~*ahrefsbot|semrush(bot)?|mj12bot|petalbot|dotbot|seznambot      1;
    ~*cloudflare-health-check|uptime|pingdom|gtmetrix|crawler|spider 1;
}

# 5) итоговый флаг логирования: ТОЛЬКО https + наш домен + НЕ бот
map "$mh_is_https:$mh_is_mirrorhub:$mh_is_known_bot" $mh_log_https_humans {
    default 0;
    "1:1:0" 1;
}

# 6) Подключаем ВСЕ per-domain конфиги MirrorHub
include /etc/nginx/sites-mirrorhub.d/*.conf;
